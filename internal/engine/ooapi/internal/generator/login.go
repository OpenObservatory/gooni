package main

import (
	"fmt"
	"strings"
	"time"
)

func (d *Descriptor) genNewLogin(sb *strings.Builder) {
	fmt.Fprintf(sb, "// %s implements login for %s.\n",
		d.WithLoginAPIStructName(), d.APIStructName())
	fmt.Fprintf(sb, "type %s struct {\n", d.WithLoginAPIStructName())
	fmt.Fprintf(sb, "\tAPI %s // mandatory\n", d.ClonerInterfaceName())
	fmt.Fprint(sb, "\tJSONCodec JSONCodec // optional\n")
	fmt.Fprint(sb, "\tKVStore KVStore // mandatory\n")
	fmt.Fprint(sb, "\tRegisterAPI RegisterCaller // mandatory\n")
	fmt.Fprint(sb, "\tLoginAPI LoginCaller // mandatory\n")
	fmt.Fprint(sb, "}\n\n")

	fmt.Fprintf(sb, "func (api *%s) Call(ctx context.Context, req %s) (%s, error) {\n",
		d.WithLoginAPIStructName(), d.RequestTypeName(), d.ResponseTypeName())
	fmt.Fprint(sb, "\ttoken, err := api.maybeLogin(ctx)\n")
	fmt.Fprint(sb, "\tif err != nil {\n")
	fmt.Fprint(sb, "\t\treturn nil, err\n")
	fmt.Fprint(sb, "\t}\n")
	fmt.Fprint(sb, "\tresp, err := api.API.WithToken(token).Call(ctx, req)\n")
	fmt.Fprint(sb, "\tif errors.Is(err, ErrUnauthorized) {\n")
	fmt.Fprint(sb, "\t\ttoken, err = api.forceRegister(ctx)\n")
	fmt.Fprint(sb, "\t\tif err != nil {\n")
	fmt.Fprint(sb, "\t\t\treturn nil, err\n")
	fmt.Fprint(sb, "\t\t}\n")
	fmt.Fprint(sb, "\t\tresp, err = api.API.WithToken(token).Call(ctx, req)\n")
	fmt.Fprint(sb, "\t\t// fallthrough\n")
	fmt.Fprint(sb, "\t}\n")
	fmt.Fprint(sb, "\tif err != nil {\n")
	fmt.Fprint(sb, "\t\treturn nil, err\n")
	fmt.Fprint(sb, "\t}\n")
	fmt.Fprint(sb, "\treturn resp, nil\n")
	fmt.Fprint(sb, "}\n\n")

	fmt.Fprintf(sb, "func (api *%s) jsonCodec() JSONCodec {\n",
		d.WithLoginAPIStructName())
	fmt.Fprint(sb, "\tif api.JSONCodec != nil {\n")
	fmt.Fprint(sb, "\t\treturn api.JSONCodec\n")
	fmt.Fprint(sb, "\t}\n")
	fmt.Fprint(sb, "\treturn &defaultJSONCodec{}\n")
	fmt.Fprint(sb, "}\n\n")

	fmt.Fprintf(sb, "func (api *%s) readstate() (*loginState, error) {\n",
		d.WithLoginAPIStructName())
	fmt.Fprint(sb, "\tdata, err := api.KVStore.Get(loginKey)\n")
	fmt.Fprint(sb, "\tif err != nil {\n")
	fmt.Fprint(sb, "\t\treturn nil, err\n")
	fmt.Fprint(sb, "\t}\n")
	fmt.Fprint(sb, "\tvar ls loginState\n")
	fmt.Fprint(sb, "\tif err := api.jsonCodec().Decode(data, &ls); err != nil {\n")
	fmt.Fprint(sb, "\t\treturn nil, err\n")
	fmt.Fprint(sb, "\t}\n")
	fmt.Fprint(sb, "\treturn &ls, nil\n")
	fmt.Fprint(sb, "}\n\n")

	fmt.Fprintf(sb, "func (api *%s) writestate(ls *loginState) error {\n",
		d.WithLoginAPIStructName())
	fmt.Fprint(sb, "\tdata, err := api.jsonCodec().Encode(*ls)\n")
	fmt.Fprint(sb, "\tif err != nil {\n")
	fmt.Fprint(sb, "\t\treturn err\n")
	fmt.Fprint(sb, "\t}\n")
	fmt.Fprint(sb, "\treturn api.KVStore.Set(loginKey, data)\n")
	fmt.Fprint(sb, "}\n\n")

	fmt.Fprintf(sb, "func (api *%s) forceRegister(ctx context.Context) (string, error) {\n",
		d.WithLoginAPIStructName())
	fmt.Fprint(sb, "\treq := newRegisterRequest()\n")
	fmt.Fprint(sb, "\tls := &loginState{}\n")
	fmt.Fprint(sb, "\tresp, err := api.RegisterAPI.Call(ctx, req)\n")
	fmt.Fprint(sb, "\tif err != nil {\n")
	fmt.Fprint(sb, "\t\treturn \"\", err\n")
	fmt.Fprint(sb, "\t}\n")
	fmt.Fprint(sb, "\tls.ClientID = resp.ClientID\n")
	fmt.Fprint(sb, "\tls.Password = req.Password\n")
	fmt.Fprint(sb, "\treturn api.doLogin(ctx, ls)\n")
	fmt.Fprint(sb, "}\n\n")

	fmt.Fprintf(sb, "func (api *%s) maybeLogin(ctx context.Context) (string, error) {\n",
		d.WithLoginAPIStructName())
	fmt.Fprint(sb, "\tls, _ := api.readstate()\n")
	fmt.Fprint(sb, "\tif ls == nil || !ls.credentialsValid() {\n")
	fmt.Fprint(sb, "\t\treturn api.forceRegister(ctx)\n")
	fmt.Fprint(sb, "\t}\n")
	fmt.Fprint(sb, "\tif !ls.tokenValid() {\n")
	fmt.Fprint(sb, "\t\treturn api.doLogin(ctx, ls)\n")
	fmt.Fprint(sb, "\t}\n")
	fmt.Fprint(sb, "\treturn ls.Token, nil\n")
	fmt.Fprint(sb, "}\n\n")

	fmt.Fprintf(sb, "func (api *%s) doLogin(ctx context.Context, ls *loginState) (string, error) {\n",
		d.WithLoginAPIStructName())
	fmt.Fprint(sb, "\treq := &apimodel.LoginRequest{\n")
	fmt.Fprint(sb, "\t\tClientID: ls.ClientID,\n")
	fmt.Fprint(sb, "\t\tPassword: ls.Password,\n")
	fmt.Fprint(sb, "\t}\n")
	fmt.Fprint(sb, "\tresp, err := api.LoginAPI.Call(ctx, req)\n")
	fmt.Fprint(sb, "\tif err != nil {\n")
	fmt.Fprint(sb, "\t\treturn \"\", err\n")
	fmt.Fprint(sb, "\t}\n")
	fmt.Fprint(sb, "\tls.Token = resp.Token\n")
	fmt.Fprint(sb, "\tls.Expire = resp.Expire\n")
	fmt.Fprint(sb, "\tif err := api.writestate(ls); err != nil {\n")
	fmt.Fprint(sb, "\t\treturn \"\", err\n")
	fmt.Fprint(sb, "\t}\n")
	fmt.Fprint(sb, "\treturn ls.Token, nil\n")
	fmt.Fprint(sb, "}\n\n")
	fmt.Fprintf(sb, "var _ %s = &%s{}\n\n", d.CallerInterfaceName(),
		d.WithLoginAPIStructName())
}

// GenLoginGo generates login.go.
func GenLoginGo() {
	var sb strings.Builder
	fmt.Fprint(&sb, "// Code generated by go generate; DO NOT EDIT.\n")
	fmt.Fprintf(&sb, "// %s\n\n", time.Now())
	fmt.Fprint(&sb, "package ooapi\n\n")
	fmt.Fprint(&sb, "//go:generate go run ./internal/generator\n\n")
	fmt.Fprint(&sb, "import (\n")
	fmt.Fprint(&sb, "\t\"context\"\n")
	fmt.Fprint(&sb, "\t\"errors\"\n")
	fmt.Fprint(&sb, "\n")
	fmt.Fprint(&sb, "\t\"github.com/ooni/probe-cli/v3/internal/engine/ooapi/apimodel\"\n")
	fmt.Fprint(&sb, ")\n")
	for _, desc := range Descriptors {
		if !desc.RequiresLogin {
			continue
		}
		desc.genNewLogin(&sb)
	}
	writefile("login.go", &sb)
}
